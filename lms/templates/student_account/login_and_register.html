<%page expression_filter="h"/>
<%!
    import json
    from django.utils.translation import ugettext as _
    from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
    from openedx.core.djangolib.js_utils import dump_js_escaped_json
%>
<%namespace name='static' file='/static_content.html'/>

<%inherit file="../main.html" />

<%block name="pagetitle">${_("Sign in or Register")}</%block>
<style>

  input[type="submit"], input[type="button"], button, .button {
    box-shadow: none !important;
    background-color: var(--primary);
    background-image: none !important;
    text-shadow: none !important;
  }

  .plaintext-honor_code{
      display: none;
  }

  .window-wrap {
    background: url("${static.url('icope/images/bg_img.png')}");
  }
  .login-register .form-field select {
    background: #fff;
  }

  #main {
    min-height: 71vh;
    height: auto;
  }

  #content-container {
    background: url("${static.url('icope/images/bg_img.png')}");
  }

  .toggle-form {
    display: none !important;
  }
  .text-profession_autre {
    display: none;
  }

</style>

% if "register" in request.path:
<style>
/* #main {
} */
</style>
% endif 

<%block name="js_extra">
    <%static:require_module module_name="js/student_account/logistration_factory" class_name="LogistrationFactory">
        var options = ${data | n, dump_js_escaped_json};
        LogistrationFactory(options);
        if ('newrelic' in window) {
            newrelic.finished();
            // Because of a New Relic bug, the finished() event doesn't show up
            // in Insights, so we have to make a new PageAction that is basically
            // the same thing. We still want newrelic.finished() for session
            // traces though.
            newrelic.addPageAction('xfinished');
        }
    </%static:require_module>
    % if configuration_helpers.get_value('DISPLAY_TOS_IN_MODAL_ON_REGISTRATION_PAGE', False):
    <script type="text/javascript" src="${static.url('js/student_account/tos_modal.js')}"></script>
    % endif
</%block>

<%block name="header_extras">
    % for template_name in ["account", "access", "form_field", "login", "register", "institution_login", "institution_register", "password_reset", "hinted_login"]:
        <script type="text/template" id="${template_name}-tpl">
            <%static:include path="student_account/${template_name}.underscore" />
        </script>
    % endfor
</%block>

<div class="section-bkg-wrapper">
    <main id="main" aria-label="Content" tabindex="-1">
        <div id="content-container" class="login-register-content">
            % if enable_enterprise_sidebar:
                <%include file="enterprise_sidebar.html" />
                <%
                    border_class = 'border-left'
                %>
            % else:
                <%
                    border_class = ''
                %>
            % endif
            <div id="login-and-registration-container" class="login-register ${border_class}"></div>
        </div>
    </main>
</div>

<!------------ layer map - begin ------------>
<div class="mapSection" id="map">
    <div class="mapSectionLayer1">
    <div class="mapSectionLayer2">
        <div class="mapSection-title-block">
        <p class="mapSection-title">Je m'inscris :</p>
        <div class="mapSection-underlineTitle"></div>
        </div>
        <div class="mapSection-closeButton">
        <img src="${static.url('icope/images/asset-croix.svg')}" alt="">
        </div>
        <div class="mapSection-map">
        <div class="mapSection-map-world">
            <div class="mapSection-map-domTom-items mapSection-regions"  onclick="selectRegion('world')">
            <img class="outremer_img" src="${static.url('icope/images/globe.png')}" alt="">
            <p id="world" style="color: #000;" class="mapSection-map-domTom-description">Pays francophones</p>
            </div>
        </div>
            <div class="mapSection-map-france">
            <img class="mapSection-mapGlobale" src="${static.url('icope/images/map/carte-fr-modif.svg')}" alt="">
            <div class="mapSection-map-regions mapSection-map-region1"  onclick="selectRegion('Pays_de_la_Loire')">
                <p id="Pays_de_la_Loire" class="mapSection-map-region-texts ">Pays de la loire</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_118.svg')}" alt=""> -->
            </div>
            <div class="mapSection-map-regions mapSection-map-region2" onclick="selectRegion('Auvergne_Rhone_Alpes')">
                <p id="Auvergne_Rhone_Alpes" class="mapSection-map-region-texts">Auvergne-Rhône-Alpes</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_119.svg')}" alt=""> -->
            </div>
            <div class="mapSection-map-regions mapSection-map-region3" onclick="selectRegion('Occitanie')">
                <p id="Occitanie" class="mapSection-map-region-texts">Occitanie</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_120.svg')}" alt=""> -->
            </div>
            <div class="mapSection-map-regions mapSection-map-region4" onclick="selectRegion('PACA')">
                <p id="PACA" class="mapSection-map-region-texts" style="width: 150px;">Provence-Alpes-Côte d'Azur</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_121.svg')}" alt=""> -->
            </div>
            <div class="mapSection-map-regions mapSection-map-region5" onclick="selectRegion('Corse')">
                <p id="Corse" class="mapSection-map-region-texts">Corse</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_122.svg')}" alt=""> -->
            </div>
            <div class="mapSection-map-regions mapSection-map-region6" onclick="selectRegion('Autre')">
                <p id="Autre" class="mapSection-map-region-texts">Autres régions</p>
                <!-- <img class="mapSection-map-regionImgs" src="${static.url('icope/images/map/Trace_122.svg')}" alt=""> -->
            </div>
            </div>
            <div class="mapSection-map-domTom">
            <div class="mapSection-map-domTom-items mapSection-regions" id="region-1" onclick="selectRegion('Guadeloupe')">
                <img class="outremer_img" src="${static.url('icope/images/map/Trace_123.svg')}" alt="">
                <p id="Guadeloupe" class="mapSection-map-domTom-description">Guadeloupe</p>
            </div>
            <div class="mapSection-map-domTom-items mapSection-regions" id="region-2" onclick="selectRegion('Martinique')">
                <img class="outremer_img" src="${static.url('icope/images/map/Trace_124.svg')}" alt="">
                <p id="Martinique" class="mapSection-map-domTom-description">Martinique</p>
            </div>
            <div class="mapSection-map-domTom-items mapSection-regions" id="region-3" onclick="selectRegion('Guyane')">
                <img class="outremer_img" src="${static.url('icope/images/map/Trace_125.svg')}" alt="">
                <p id="Guyane" class="mapSection-map-domTom-description">Guyane</p>
            </div>
            <div class="mapSection-map-domTom-items mapSection-regions" id="region-4" onclick="selectRegion('Reunion')">
                <img class="outremer_img" src="${static.url('icope/images/map/Trace_126.svg')}" alt="">
                <p id="Reunion" class="mapSection-map-domTom-description">La réunion</p>
            </div>
            <div class="mapSection-map-domTom-items mapSection-regions" id="region-5" onclick="selectRegion('Mayotte')">
                <img class="outremer_img" src="${static.url('icope/images/map/Groupe_2.svg')}" alt="">
                <p id="Mayotte" class="mapSection-map-domTom-description">Mayotte</p>
            </div>
            </div>
        </div>
        <div class="mapSection-button">
        <a class="mapSection-buttonLink">Selectionnez votre région</a>
        </div>
    </div>
    </div>
</div>
<!------------ layer map - end ------------>


<%include file="${static.get_template_path('../footer.html')}" />







<script>
  
// ---------------- map show / hide ----------------------

// var registerButton = setInterval(function() {

  const registerButtonHeader = document.querySelector(".register-btn-header")
  const map = document.querySelector(".mapSection")
  const home = document.querySelector('.section-bkg-wrapper')
  const header = document.querySelector('.global-header')
  const closeButton = document.querySelector('.mapSection-closeButton')
  

  registerButtonHeader.addEventListener('click', ()=>{
    console.log('ciblage-ok')
    
    home.style.filter = "blur(0.5rem)"
    header.style.filter = "blur(0.5rem)"
    console.log('filter-ok')
    
    map.classList.toggle('mapSection-show')
    console.log('map-showing-ok')
  })
  
  closeButton.addEventListener('click', ()=>{
    console.log('ciblage-2-ok')
    
    home.style.filter = "blur(0rem)"
    header.style.filter = "blur(0rem)"
    console.log('blur-off')
    
    map.classList.toggle('mapSection-show')
    console.log('map-hidden')
  })
  
  const loginButton2 = document.querySelector(".sign-in-btn-header")
  loginButton2.addEventListener('click', ()=>{
    window.location = "/login"
  })
  
  // ------------------- map functions ----------------------
  
  const regions = document.querySelectorAll('.mapSection-regions')
  const button = document.querySelector('.mapSection-buttonLink')
  
  regions.forEach((item)=>{
    item.addEventListener('click', (e)=>{
      console.log(e)
      console.log(e.target.id)
      switch(e.target.id){
        case "region-1":
          button.href = "/register?course_id=course-v1:icope+Occitanie+2022&enrollment_action=enroll"
          break
        case "region-2":
          button.href = "https://www.google.fr/"
          break
        case "region-3":
          button.href = ""
          break
        default:
          null
      }
    })
  })
// }, 500)

</script>


<script>

function restart_color_button(){
      const all_region_button = document.getElementsByClassName("mapSection-map-region-texts")
      for (region of all_region_button){
        region.style.color = "#fff"
      }
      const all_region_domtom_button = document.getElementsByClassName("mapSection-map-domTom-description")
      for (region of all_region_domtom_button){
        region.style.color = "#000"
      }
      
    }

function selectRegion(region) {

  const redirect_to_occitanie = ['Autre', 'Guadeloupe', 'Martinique', 'Guyane', 'Mayotte', 'Reunion', 'world']

  const button = document.querySelector('.mapSection-buttonLink')
  const buttonDiv = document.querySelector('.mapSection-button')
  
  const selectedText = document.getElementById(region)
  restart_color_button()
  selectedText.style.color = "#F2816F"

  buttonDiv.style.background =  "#F2816F"
  if (redirect_to_occitanie.includes(region)) {
    region = 'Occitanie'
  }
  button.href = "/register?course_id=course-v1%3Aicope%2B" + region + "%2B2022&enrollment_action=enroll"
}

// Avoid people trying to register without enroll
if (window.location.href == 'https://icope-formation.com/register') {
  window.location.href = 'https://icope-formation.com';
}
if (window.location.href == 'https://icope.koa.qualif.dev/register') {
  window.location.href = 'https://icope.koa.qualif.dev';
}



// ________________________________
// --------REGISTER FORM UPDATE--------
// ________________________________

// Hide profession fields :
var alreadyPassed = false
var functionForm = setInterval(() => {
  $("#register-profession").change(function() {
    var val = $(this).val();
    if(val === "Autre (précisez)") {
      $(".text-profession_autre").show();
    } else {
      $(".text-profession_autre").hide();
    }
  })
  if (alreadyPassed) {
    clearInterval(functionForm)
  }
  alreadyPassed = true
}, 700);


var replaceText = setInterval(() => {

  if (window.location.href.indexOf('login') == -1) {
    clearInterval(replaceText)
  } else {
    
    var textTarget = $('#login-email-desc')
    textTarget[0].textContent = textTarget[0].textContent.replace('icope', 'le e-learning.')
    
    if (textTarget[0].textContent.indexof('icope') == -1) {
      clearInterval(replaceText)
    }
  }
}, 400);

var replaceTextField = setInterval(() => {

  var textTarget = $('.label-text')
  test1 = false

  for (let i = 0; i < textTarget.length; i++) {
    const elem = textTarget[i];
    if (elem.textContent.indexOf('public') != -1 || elem.textContent.indexOf('Public') != -1) {
      elem.textContent = 'Pseudo'
      test1 = true
    }
  }

  if (test1) {
    clearInterval(replaceTextField)
  }

}, 400);


// ---------------------------------
// ----- Update Departement field regarding Region field 
// ---------------------------------

const table = {
  "Auvergne-Rh\u00f4ne-Alpes": ["","Ain","Allier","Ardeche","Cantal","Drome","Isere","Loire","Haute-loire",'Puy-de-dome', 'Rhone', 'Savoie', 'Haute-savoie'],
  "Bourgogne-Franche-Comt\u00e9" : ["","Cote-d'Or", 'Doubs', 'Jura', 'Nievre','Haute-saone', 'Saone-et-loire', 'Yonne', 'Territoire-de-belfort'],
  "Bretagne" : ["", "Cotes-d'Armor",'Finistere', 'Ille-et-vilaine', 'Morbihan'],
  "Centre-Val de Loire" : ["", 'Cher', 'Eure-et-loir', 'Loir-et-cher','Loiret'],
  "Corse" : ["",'Corse-du-sud', 'Haute-corse'],
  "Grand Est" :['','Ardennes', 'Aube', 'Marne', 'Haute-marne', 'Meurthe-et-moselle', 'Meuse', 'Moselle', 'Bas-rhin', 'Haut-rhin','Vosges'], 
  "Guadeloupe" : ["","Guadeloupe"],
  "Guyane" : ["","Guyane"],
  "Hauts-de-France" : ["",'Aisne', 'Nord', 'Oise', 'Pas-de-calais', 'Somme'],
  "\u00cele-de-France" : ["",'Paris', 'Seine-et-marne','Yvelines', 'Essone', 'Haut-de-seine', 'Seine-saint-denis', 'Val-de-marne', "Val-d'Oise"],
  "La R\u00e9union" : ["","La-reunion"],
  "Martinique" : ["",'Martinique'],
  "Mayotte" : ["","Mayotte"],
  "Normandie" : ["",'Calvados', 'Eure', 'Manche', 'Orne', 'Seine-maritime'],
  "Nouvelle-Aquitaine" : ["",'Charente', 'Charente-maritime', 'Correze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-garonne', 'Pyrenees-atlantiques', 'Deux-sevres','Vienne', 'Haute-vienne'],
  "Occitanie" : ["",'Arriege','Aude','Aveyron', 'Gard', 'Haute-garonne','Gers','Herault','Lot', 'Lozere', 'Hautes-pyrenees', 'Pyrenees-orientales','Tarn','Tarn-et-garonne'],
  "Pays de la Loire" : ["",'Loire-atlantique', 'Maine-et-loire', 'Mayenne', 'Sarthe', 'Vendee'],
  "Provence-Alpes-C\u00f4te d'Azur" : ["",'Alpes-de-haute-provence', 'Hautes-alpes','Alpes-maritimes','Bouches-du-rhone','Var','Vaucluse'],
  "Autre" : ["","Saint-pierre-et-miquelon", 'Sainte-barthelemy', 'Saint-martin', 'Wallis-et-futuna', 'Polynesie-francaise', 'Nouvelle-caledonie'],
}

var functionToRegion = setInterval(() => {

  $('#register-region').change(function(){
        
    let value = $('#register-region').val()
    console.log('value');
    console.log(value);

    // Remove all options for departement
    $('#register-department').find('option').remove().end()
    
    if (value) {
      for (let i = 0; i < Object.keys(table).length; i++) {

        if (Object.keys(table)[i] == value) {
                    
          const departementList = table[ Object.keys(table)[i] ];
          
          console.log('------------departementList-------------');
          console.log(departementList);
          console.log('------------departementList-------------');
          
          departementList.sort()// sort elements alphabetically

          console.log('------------departementList sorted-------------');
          console.log(departementList);
          console.log('------------departementList sorted-------------');

          for (let i = 0; i < departementList.length; i++) {
            const departement = departementList[i];

            // Add selected option for departement 
            $('#register-department').append("<option value='"+ departement + "'>" + departement + "</option>");

            console.log('-------------departement------------');
            console.log(departement);
            console.log('-------------departement------------');

          }
        }
        
      }
      check_add_option = false
    }
  })

  clearInterval(functionToRegion)

}, 700);

</script>


<!-- quentin - ticket 15338 - script change text full name field -->

<script>

// window.addEventListener("load", ()=>{
//   document.querySelector('#register-name-required-label').previousElementSibling.textContent = 'Nom complet (Prénom + Nom)'
// })

window.setInterval(()=>{
  document.querySelector('#register-name-required-label').previousElementSibling.textContent = 'Nom complet (Prénom + Nom)'
}, 150)

</script>