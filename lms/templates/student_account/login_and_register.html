<%page expression_filter="h"/>
<%!
    import json
    from django.utils.translation import ugettext as _
    from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
    from openedx.core.djangolib.js_utils import dump_js_escaped_json
%>
<%namespace name='static' file='/static_content.html'/>

<%inherit file="../main.html" />

<%block name="pagetitle">${_("Sign in or Register")}</%block>
<style>

  input[type="submit"], input[type="button"], button, .button {
    box-shadow: none !important;
    background-color: var(--primary);
    background-image: none !important;
    text-shadow: none !important;
  }

  .plaintext-honor_code{
      display: none;
  }

  .window-wrap {
    background: url("${static.url('icope/images/bg_img.png')}");
  }
  .login-register .form-field select {
    background: #fff;
  }
  #main {
    min-height: 71vh;
    height: auto;
  }
  #content-container {
    background: url("${static.url('icope/images/bg_img.png')}");
    display: flex;
    flex-direction: column;
  }
  .toggle-form {
    display: none !important;
  }
  .text-profession_autre {
    display: none;
  }
  .form-field.select-department{
    display: none;
  }
  a {
    color: #C2C6CA !important;
  }
  #register-terms_of_service-optional-label {
    display: none;
  }

</style>


%if request.get_full_path().find('/register?course_id=course-v1:icope+soins_bucco_dentaires+2024&enrollment_action=enroll') !=  -1 :  
<script>
  setTimeout(() => {
    $('#register-parcours').removeAttr('required');
  }, 1000);
</script>
<style>
  .required-fields > .select-parcours {
    display: none;
  }
  #bucco-dentaire-msg {
    display: block !important;
    background: #fff;
    margin: 0 auto;
    padding: 40px 10px 0 10px;
    font-size: larger;
    max-width: 500px;
    color: #F2816F;
    line-height: 1.5;
    text-align: justify;
  }
  #bucco-dentaire-msg > a {
    text-decoration: underline !important;
    color: #206892 !important;
  }
</style>
%endif

%if request.get_full_path().find('soins_bucco_dentaires') !=  -1 :  
<style>
  nav.position-header {
    display: none;
  }
</style>
%endif



<%block name="js_extra">

<%static:require_module module_name="js/student_account/logistration_factory" class_name="LogistrationFactory">
    var options = ${data | n, dump_js_escaped_json};
        LogistrationFactory(options);

        if ('newrelic' in window) {
          newrelic.finished();
          // Because of a New Relic bug, the finished() event doesn't show up
          // in Insights, so we have to make a new PageAction that is basically
          // the same thing. We still want newrelic.finished() for session
          // traces though.
          newrelic.addPageAction('xfinished');
      }


    </%static:require_module>
    % if configuration_helpers.get_value('DISPLAY_TOS_IN_MODAL_ON_REGISTRATION_PAGE', False):
    <script type="text/javascript" src="${static.url('js/student_account/tos_modal.js')}"></script>
    % endif
</%block>

<%block name="header_extras">
    % for template_name in ["account", "access", "form_field", "login", "register", "institution_login", "institution_register", "password_reset", "hinted_login"]:
        <script type="text/template" id="${template_name}-tpl">
            <%static:include path="student_account/${template_name}.underscore" />
        </script>
    % endfor
</%block>

<div class="section-bkg-wrapper">
    <main id="main" aria-label="Content" tabindex="-1">
        <div id="content-container" class="login-register-content">
            % if enable_enterprise_sidebar:
                <%include file="enterprise_sidebar.html" />
                <%
                    border_class = 'border-left'
                %>
            % else:
                <%
                    border_class = ''
                %>
            % endif
            <div id="bucco-dentaire-msg" style="display: none;">
              <strong>ATTENTION :</strong> Si vous poss√©dez d√©j√† un compte sur la plateforme icope-formation.com vous pouvez acc√©der directement √† la formation bucco-dentaire en vous <a href="/login?course-v1:icope+soins_bucco_dentaires+2024&enrollment_action=enroll">connectant ici</a>  
            </div>
            <div id="login-and-registration-container" class="login-register ${border_class}"></div>
        </div>
    </main>
</div>

<%include file="${static.get_template_path('../footer.html')}" />


<script>

// ____________________________________
// 
// --------REGISTER FORM UPDATE--------
// ____________________________________

// Hide profession fields :
var alreadyPassed = false
var functionForm = setInterval(() => {

  $("#register-profession").change(function() {
    var val = $(this).val();
    if(val === "Autre (pr√©cisez)") {
      $(".text-profession_autre").show();
    } else {
      $(".text-profession_autre").hide();
    }
  })
  if (alreadyPassed) {
    clearInterval(functionForm)
  }
  alreadyPassed = true

}, 700);


var replaceText = setInterval(() => {

  if (window.location.href.indexOf('login') == -1) {
    clearInterval(replaceText)
  } else {
    
    var textTarget = $('#login-email-desc')
    textTarget[0].textContent = textTarget[0].textContent.replace('icope', 'le e-learning.')
    
    if (textTarget[0].textContent.indexof('icope') == -1) {
      clearInterval(replaceText)
    }
  }
}, 400);

var replaceTextField = setInterval(() => {

  var textTarget = $('.label-text')
  test1 = false

  for (let i = 0; i < textTarget.length; i++) {
    const elem = textTarget[i];
    if (elem.textContent.indexOf('public') != -1 || elem.textContent.indexOf('Public') != -1) {
      elem.textContent = 'Pseudo'
      test1 = true
    }
  }

  if (test1) {
    clearInterval(replaceTextField)
  }

}, 400);


// Update Departement field regarding Region field 

const table = {
  "Auvergne-rhone-alpes": ["","Ain","Allier","Ard√®che","Cantal","Dr√¥me","Is√®re","Loire","Haute-loire",'Puy-de-D√¥me', 'Rh√¥ne', 'Savoie', 'Haute-Savoie'],
  "bourgogne-franche-comte" : ["","C√¥te-d'Or", 'Doubs', 'Jura', 'Ni√®vre','Haute-Sa√¥ne', 'Sa√¥ne-et-loire', 'Yonne', 'Territoire de Belfort'],
  "Bretagne" : ["", "C√¥tes-d'Armor",'Finist√®re', 'Ille-et-Vilaine', 'Morbihan'],
  "Centre-val-de-loire" : ["", 'Cher', 'Eure-et-Loir','Indre','Indre-et-Loire','Loir-et-Cher','Loiret'],
  "Corse" : ["",'Corse-du-sud', 'Haute-Corse'],
  "Grand-est" :['','Ardennes', 'Aube', 'Marne', 'Haute-Marne', 'Meurthe-et-Moselle', 'Meuse', 'Moselle', 'Bas-Rhin', 'Haut-Rhin','Vosges'], 
  "Guadeloupe" : ["","Guadeloupe"],
  "Guyane" : ["","Guyane"],
  "Hauts-de-france" : ["",'Aisne', 'Nord', 'Oise', 'Pas-de-Calais', 'Somme'],
  "Ile-de-france" : ["",'Paris', 'Seine-et-Marne','Yvelines', 'Essone', 'Hauts-de-Seine', 'Seine-Saint-Denis', 'Val-de-Marne', "Val-d'Oise"],
  "La-reunion" : ["","La R√©union"],
  "Martinique" : ["",'Martinique'],
  "Mayotte" : ["","Mayotte"],
  "Normandie" : ["",'Calvados', 'Eure', 'Manche', 'Orne', 'Seine-Maritime'],
  "Nouvelle-aquitaine" : ["",'Charente', 'Charente-Maritime', 'Corr√®ze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-Garonne', 'Pyr√©n√©es-Atlantiques', 'Deux-S√®vres','Vienne', 'Haute-Vienne'],
  "Occitanie" : ["",'Arri√®ge','Aude','Aveyron', 'Gard', 'Haute-Garonne','Gers','H√©rault','Lot', 'Loz√®re', 'Hautes-Pyr√©n√©es', 'Pyr√©n√©es-Orientales','Tarn','Tarn-et-Garonne'],
  "Pays-de-la-loire" : ["",'Loire-Atlantique', 'Maine-et-Loire', 'Mayenne', 'Sarthe', 'Vend√©e'],
  "Provence-alpes-cote-d-azur" : ["",'Alpes-de-Haute-Provence', 'Hautes-Alpes','Alpes-Maritimes','Bouches-du-Rh√¥ne','Var','Vaucluse'],
  "Autre" : ["","Saint-Pierre-et-Miquelon", 'Sainte-Barth√©lemy', 'Saint-Martin', 'Wallis-et-Futuna', 'Polyn√©sie francaise', 'Nouvelle-Cal√©donie'],
}

function nettoyerValue(text) {
  text = text
    .replace(/[√©√®√™]/g, 'e')
    .replace(/√¥/g, 'o')
    .replace(/√Æ/g, 'i')
    .replace(/'/g, '_')
    .replace(/ /g, '__')
    .toLowerCase();

  return text;
}

function updateDept() {
  $('#register-region').change(function(){
    const sectionDepartment = document.querySelector('.form-field.select-department')
    const regionSelectorValue = document.getElementById('register-region').value

    if (document.getElementById('register-region').value != '') {
      document.getElementsByClassName('select-department')[0].style.display = 'block' 
      sectionDepartment.style.display='block'
      $('#register-department').empty()

      for (const region in table) {
        if (region == document.getElementById('register-region').value) {
          for (const departement of table[region]) {

            $('#register-department').append("<option value='"+ nettoyerValue(departement) + "'>" + departement + "</option>");

          }
        }
      }
    } else if (document.getElementById('register-region').value == '') {

      document.getElementsByClassName('select-department')[0].style.display = 'none' 
      sectionDepartment.style.display='none'

    } else {
      console.log('ü§î something is not working with hidding department section script');
    }
  })
}

const functionToRegion = setTimeout(() => {
  updateDept();
}, 3000);



window.setTimeout(()=>{

  if (document.querySelector('#register-name-required-label')) {
    document.querySelector('#register-name-required-label').previousElementSibling.textContent = 'Nom complet (Pr√©nom + Nom)'
  }
 
}, 500)

// Reset password feature
var resetLink = setInterval(() => {

  let newResetLink = "To protect your account, it‚Äôs been temporarily locked. Try again in 30 minutes.<br> To be on the safe side, you can reset your password <button type='button' class='field-link form-toggle' data-type='password-reset' style='border:none;color:black;padding:0;font-size:inherit;font-weight:700;vertical-align:unset;'>here</button> before you try again."
  let oldResetLink = document.getElementsByClassName('message-copy')[0].children

  if (oldResetLink[0].innerHTML.indexOf('/reset') != -1) {
    oldResetLink[0].innerHTML = newResetLink
  }
}, 400);

</script>
