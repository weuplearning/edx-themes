<%page expression_filter="h"/>
<%!
    import json
    from django.utils.translation import ugettext as _
    from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
    from openedx.core.djangolib.js_utils import dump_js_escaped_json
%>
<%namespace name='static' file='/static_content.html'/>

<%inherit file="../main.html" />

<%block name="pagetitle">${_("Sign in or Register")}</%block>
<style>

  input[type="submit"], input[type="button"], button, .button {
    box-shadow: none !important;
    background-color: var(--primary);
    background-image: none !important;
    text-shadow: none !important;
  }

  .plaintext-honor_code{
      display: none;
  }

  .window-wrap {
    background: url("${static.url('icope/images/bg_img.png')}");
  }
  .login-register .form-field select {
    background: #fff;
  }

  #main {
    min-height: 71vh;
    height: auto;
  }

  #content-container {
    background: url("${static.url('icope/images/bg_img.png')}");
  }

  .toggle-form {
    display: none !important;
  }
  .text-profession_autre {
    display: none;
  }

  /* modifs quentin - ticket 15377 - hide department section if region isn't selected first */
  .form-field.select-department{
    display: none;
  }

</style>

% if "register" in request.path:
<style>
/* #main {
} */
</style>
% endif 
<script>

</script>
<%block name="js_extra">

<%static:require_module module_name="js/student_account/logistration_factory" class_name="LogistrationFactory">
    var options = ${data | n, dump_js_escaped_json};
        LogistrationFactory(options);

        const table = {
          "Auvergne-Rh\u00f4ne-Alpes": ["","Ain","Allier","Ardeche","Cantal","Drome","Isere","Loire","Haute-loire",'Puy-de-dome', 'Rhone', 'Savoie', 'Haute-savoie'],
          "Bourgogne-Franche-Comt\u00e9" : ["","Cote-d'Or", 'Doubs', 'Jura', 'Nievre','Haute-saone', 'Saone-et-loire', 'Yonne', 'Territoire-de-belfort'],
          "Bretagne" : ["", "Cotes-d'Armor",'Finistere', 'Ille-et-vilaine', 'Morbihan'],
          "Centre-Val de Loire" : ["", 'Cher', 'Eure-et-loir', 'Loir-et-cher','Loiret'],
          "Corse" : ["",'Corse-du-sud', 'Haute-corse'],
          "Grand Est" :['','Ardennes', 'Aube', 'Marne', 'Haute-marne', 'Meurthe-et-moselle', 'Meuse', 'Moselle', 'Bas-rhin', 'Haut-rhin','Vosges'], 
          "Guadeloupe" : ["","Guadeloupe"],
          "Guyane" : ["","Guyane"],
          "Hauts-de-France" : ["",'Aisne', 'Nord', 'Oise', 'Pas-de-calais', 'Somme'],
          "\u00cele-de-France" : ["",'Paris', 'Seine-et-marne','Yvelines', 'Essone', 'Haut-de-seine', 'Seine-saint-denis', 'Val-de-marne', "Val-d'Oise"],
          "La R\u00e9union" : ["","La-reunion"],
          "Martinique" : ["",'Martinique'],
          "Mayotte" : ["","Mayotte"],
          "Normandie" : ["",'Calvados', 'Eure', 'Manche', 'Orne', 'Seine-maritime'],
          "Nouvelle-Aquitaine" : ["",'Charente', 'Charente-maritime', 'Correze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-garonne', 'Pyrenees-atlantiques', 'Deux-sevres','Vienne', 'Haute-vienne'],
          "Occitanie" : ["",'Arriege','Aude','Aveyron', 'Gard', 'Haute-garonne','Gers','Herault','Lot', 'Lozere', 'Hautes-pyrenees', 'Pyrenees-orientales','Tarn','Tarn-et-garonne'],
          "Pays de la Loire" : ["",'Loire-atlantique', 'Maine-et-loire', 'Mayenne', 'Sarthe', 'Vendee'],
          "Provence-Alpes-C\u00f4te d'Azur" : ["",'Alpes-de-haute-provence', 'Hautes-alpes','Alpes-maritimes','Bouches-du-rhone','Var','Vaucluse'],
          "Autre" : ["","Saint-pierre-et-miquelon", 'Sainte-barthelemy', 'Saint-martin', 'Wallis-et-futuna', 'Polynesie-francaise', 'Nouvelle-caledonie'],
        }

        const regionTable = {
          "Auvergne-Rh\u00f4ne-Alpes": "Auvergne_Rhone_Alpes",
          "Bourgogne-Franche-Comt\u00e9" : "Occitanie",
          "Bretagne" : "Occitanie",
          "Centre-Val de Loire" : "Centre_Val_de_Loire",
          "Corse" : "Corse",
          "Grand Est" : "Grand_Est", 
          "Guadeloupe" : "Occitanie",
          "Guyane" : "Occitanie",
          "Hauts-de-France" : "Occitanie",
          "\u00cele-de-France" : "Occitanie",
          "La R\u00e9union" : "La_Reunion",
          "Martinique" : "Occitanie",
          "Mayotte" : "Occitanie",
          "Normandie" : "Occitanie",
          "Nouvelle-Aquitaine" : "Nouvelle_Aquitaine",
          "Occitanie" : "Occitanie",
          "Pays de la Loire" : "Pays_de_la_Loire",
          "Provence-Alpes-C\u00f4te d'Azur" : "PACA",
          "Autre" : "Occitanie"
        }



        const regionSelector = document.getElementById('register-region')
        regionSelector.addEventListener('change', function (e) {
          const regionSelectorValue = document.getElementById('register-region').value
          if (regionTable[regionSelectorValue]) {
            options.login_redirect_url = '/account/finish_auth?course_id=course-v1%3Aicope+' + regionTable[regionSelectorValue] + '+2022&enrollment_action=enroll&next=%2Fdashboard'
          } 
          console.log(options.login_redirect_url)
          const sectionDepartment = document.querySelector('.form-field.select-department')
          
          const queryParams = new URLSearchParams(window.location.search);
          queryParams.set('course_id', 'course-v1:icope+' + regionTable[regionSelectorValue] + '+2022');
          history.replaceState(null, null, "?"+queryParams.toString()); 
          const usernameValue = document.getElementById('register-username').value
          const emailValue = document.getElementById('register-email').value
          const passwordValue = document.getElementById('register-password').value
          const nameValue = document.getElementById('register-name').value
          const adressValue = document.getElementById('register-adress').value
          const postcodeValue = document.getElementById('register-post_code').value
          const cityValue = document.getElementById('register-city').value

          LogistrationFactory(options);
          document.getElementById('register-username').value = usernameValue
          document.getElementById('register-email').value = emailValue
          document.getElementById('register-password').value = passwordValue
          document.getElementById('register-name').value = nameValue
          document.getElementById('register-adress').value = adressValue
          document.getElementById('register-post_code').value = postcodeValue
          document.getElementById('register-city').value = cityValue


          console.log(options.login_redirect_url)

          document.getElementById('register-region').value = regionSelectorValue
          if (document.getElementById('register-region').value != '') {
            document.getElementsByClassName('select-department')[0].style.display = 'block' 
            sectionDepartment.style.display='block'
            $('#register-department').empty();
            setTimeout(() => {
              for (const region in table) {
                if (region == document.getElementById('register-region').value) {
                  for (const departement of table[region]) {
                    $('#register-department').append("<option value='"+ departement + "'>" + departement + "</option>");
                  }
                }
              }
            }, 500)

          }
          else if (document.getElementById('register-region').value == ''){
            document.getElementsByClassName('select-department')[0].style.display = 'none' 
            sectionDepartment.style.display='none'
          }
          else{
            console.log('ðŸ¤” something is not working with hidding department section script');
          }
        })
        if ('newrelic' in window) {
          newrelic.finished();
          // Because of a New Relic bug, the finished() event doesn't show up
          // in Insights, so we have to make a new PageAction that is basically
          // the same thing. We still want newrelic.finished() for session
          // traces though.
          newrelic.addPageAction('xfinished');
      }


    </%static:require_module>
    % if configuration_helpers.get_value('DISPLAY_TOS_IN_MODAL_ON_REGISTRATION_PAGE', False):
    <script type="text/javascript" src="${static.url('js/student_account/tos_modal.js')}"></script>
    % endif
</%block>

<%block name="header_extras">
    % for template_name in ["account", "access", "form_field", "login", "register", "institution_login", "institution_register", "password_reset", "hinted_login"]:
        <script type="text/template" id="${template_name}-tpl">
            <%static:include path="student_account/${template_name}.underscore" />
        </script>
    % endfor
</%block>

<div class="section-bkg-wrapper">
    <main id="main" aria-label="Content" tabindex="-1">
        <div id="content-container" class="login-register-content">
            % if enable_enterprise_sidebar:
                <%include file="enterprise_sidebar.html" />
                <%
                    border_class = 'border-left'
                %>
            % else:
                <%
                    border_class = ''
                %>
            % endif
            <div id="login-and-registration-container" class="login-register ${border_class}"></div>
        </div>
    </main>
</div>




<%include file="${static.get_template_path('../footer.html')}" />








<script>





// ________________________________
// --------REGISTER FORM UPDATE--------
// ________________________________

// Hide profession fields :
var alreadyPassed = false
var functionForm = setInterval(() => {
  $("#register-profession").change(function() {
    var val = $(this).val();
    if(val === "Autre (prÃ©cisez)") {
      $(".text-profession_autre").show();
    } else {
      $(".text-profession_autre").hide();
    }
  })
  if (alreadyPassed) {
    clearInterval(functionForm)
  }
  alreadyPassed = true
}, 700);


var replaceText = setInterval(() => {

  if (window.location.href.indexOf('login') == -1) {
    clearInterval(replaceText)
  } else {
    
    var textTarget = $('#login-email-desc')
    textTarget[0].textContent = textTarget[0].textContent.replace('icope', 'le e-learning.')
    
    if (textTarget[0].textContent.indexof('icope') == -1) {
      clearInterval(replaceText)
    }
  }
}, 400);

var replaceTextField = setInterval(() => {

  var textTarget = $('.label-text')
  test1 = false

  for (let i = 0; i < textTarget.length; i++) {
    const elem = textTarget[i];
    if (elem.textContent.indexOf('public') != -1 || elem.textContent.indexOf('Public') != -1) {
      elem.textContent = 'Pseudo'
      test1 = true
    }
  }

  if (test1) {
    clearInterval(replaceTextField)
  }

}, 400);


// ---------------------------------
// ----- Update Departement field regarding Region field 
// ---------------------------------

const table = {
  "Auvergne-Rh\u00f4ne-Alpes": ["","Ain","Allier","Ardeche","Cantal","Drome","Isere","Loire","Haute-loire",'Puy-de-dome', 'Rhone', 'Savoie', 'Haute-savoie'],
  "Bourgogne-Franche-Comt\u00e9" : ["","Cote-d'Or", 'Doubs', 'Jura', 'Nievre','Haute-saone', 'Saone-et-loire', 'Yonne', 'Territoire-de-belfort'],
  "Bretagne" : ["", "Cotes-d'Armor",'Finistere', 'Ille-et-vilaine', 'Morbihan'],
  "Centre-Val de Loire" : ["", 'Cher', 'Eure-et-loir', 'Loir-et-cher','Loiret'],
  "Corse" : ["",'Corse-du-sud', 'Haute-corse'],
  "Grand Est" :['','Ardennes', 'Aube', 'Marne', 'Haute-marne', 'Meurthe-et-moselle', 'Meuse', 'Moselle', 'Bas-rhin', 'Haut-rhin','Vosges'], 
  "Guadeloupe" : ["","Guadeloupe"],
  "Guyane" : ["","Guyane"],
  "Hauts-de-France" : ["",'Aisne', 'Nord', 'Oise', 'Pas-de-calais', 'Somme'],
  "\u00cele-de-France" : ["",'Paris', 'Seine-et-marne','Yvelines', 'Essone', 'Haut-de-seine', 'Seine-saint-denis', 'Val-de-marne', "Val-d'Oise"],
  "La R\u00e9union" : ["","La-reunion"],
  "Martinique" : ["",'Martinique'],
  "Mayotte" : ["","Mayotte"],
  "Normandie" : ["",'Calvados', 'Eure', 'Manche', 'Orne', 'Seine-maritime'],
  "Nouvelle-Aquitaine" : ["",'Charente', 'Charente-maritime', 'Correze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-garonne', 'Pyrenees-atlantiques', 'Deux-sevres','Vienne', 'Haute-vienne'],
  "Occitanie" : ["",'Arriege','Aude','Aveyron', 'Gard', 'Haute-garonne','Gers','Herault','Lot', 'Lozere', 'Hautes-pyrenees', 'Pyrenees-orientales','Tarn','Tarn-et-garonne'],
  "Pays de la Loire" : ["",'Loire-atlantique', 'Maine-et-loire', 'Mayenne', 'Sarthe', 'Vendee'],
  "Provence-Alpes-C\u00f4te d'Azur" : ["",'Alpes-de-haute-provence', 'Hautes-alpes','Alpes-maritimes','Bouches-du-rhone','Var','Vaucluse'],
  "Autre" : ["","Saint-pierre-et-miquelon", 'Sainte-barthelemy', 'Saint-martin', 'Wallis-et-futuna', 'Polynesie-francaise', 'Nouvelle-caledonie'],
}

// var functionToRegion = setInterval(() => {
//   console.log("test")

//   // $('#register-region').change(function(){
//     console.log("*************change22*****************")
//     const sectionDepartment = document.querySelector('.form-field.select-department')
//     const regionSelectorValue = document.getElementById('register-region').value
        
//     if (document.getElementById('register-region').value != '') {
//             document.getElementsByClassName('select-department')[0].style.display = 'block' 
//             sectionDepartment.style.display='block'
//             $('#register-department').empty()
//             setTimeout(() => {
//               for (const region in table) {
//                 if (region == document.getElementById('register-region').value) {
//                   for (const departement of table[region]) {
//                     console.log(departement)
//                     $('#register-department').append("<option value='"+ departement + "'>" + departement + "</option>");

//                     clearInterval(functionToRegion)
//                   }
//                 }
//               }
//             }, 700)

//           }
//           else if (document.getElementById('register-region').value == ''){
//             document.getElementsByClassName('select-department')[0].style.display = 'none' 
//             sectionDepartment.style.display='none'
//           }
//           else{
//             console.log('ðŸ¤” something is not working with hidding department section script');
//           }
//   // })

//   // clearInterval(functionToRegion)

// }, 700);

function updateDept() {
  $('#register-region').change(function(){
    const sectionDepartment = document.querySelector('.form-field.select-department')
    const regionSelectorValue = document.getElementById('register-region').value
        
    if (document.getElementById('register-region').value != '') {
            document.getElementsByClassName('select-department')[0].style.display = 'block' 
            sectionDepartment.style.display='block'
            $('#register-department').empty()
              for (const region in table) {
                if (region == document.getElementById('register-region').value) {
                  for (const departement of table[region]) {
                    $('#register-department').append("<option value='"+ departement + "'>" + departement + "</option>");
                  }
                }
              }

          }
          else if (document.getElementById('register-region').value == ''){
            document.getElementsByClassName('select-department')[0].style.display = 'none' 
            sectionDepartment.style.display='none'
          }
          else{
            console.log('ðŸ¤” something is not working with hidding department section script');
          }
  })
}

const functionToRegion = setInterval(() => {
    updateDept();
  }, 3000);
// </script>


<!-- quentin - ticket 15338 - script change text full name field -->

<script>

window.setTimeout(()=>{
  if (document.querySelector('#register-name-required-label')) {
    document.querySelector('#register-name-required-label').previousElementSibling.textContent = 'Nom complet (PrÃ©nom + Nom)'
  }
 
}, 500)

</script>


<!-- modifs quentin - ticket 15377 - hide department section if region isn't selected first -->

<!-- <script>

  setTimeout(() => {
    const sectionDepartment = document.querySelector('.form-field.select-department')
    const sectionRegion = document.querySelector('#register-region')
    
    // console.log('ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ sectionDepartment'+sectionDepartment);
    // console.log('ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ðŸ’§ sectionRegion'+sectionRegion);

    sectionRegion.addEventListener('change', ()=>{
      let selectedRegion = sectionRegion.value
      
      // console.log('ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ sectionRegion : '+sectionRegion)
      // console.log('ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ selectedRegion : '+selectedRegion)

      if (selectedRegion != '') {
        console.log('there is a value for sectionRegions');
        sectionDepartment.style.display='block'
        console.log('sectionDepartment displayed');
      }
      else if (selectedRegion == ''){
        console.log('sectionDepartment hidden');
        sectionDepartment.style.display='none'
      }
      else{
        console.log('ðŸ¤” something is not working with hidding department section script');
      }
    })
  }, 500)
</script> -->