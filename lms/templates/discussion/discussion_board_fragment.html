## mako

<%namespace name='static' file='../static_content.html'/>

<%page expression_filter="h"/>

<%!
import json
from django.utils.translation import ugettext as _
from django.template.defaultfilters import escapejs
from django.urls import reverse

from lms.djangoapps.discussion.django_comment_client.permissions import has_permission
from openedx.core.djangolib.js_utils import dump_js_escaped_json, js_escaped_string
from openedx.core.djangolib.markup import HTML
%>
<style>

  .discussion_topics_listbox{
    overflow-y: auto !important;
  }
    .thread-main-wrapper{
        background-color: #E7EEF4;
    }

    .discussion-response{
        background-color: #FEF1BA !important;
        padding-left: 60px !important;
    }
    .container-fluid{
        display: none;
    }


    /* footer */

    .wrapper-footer {
      background-color: #E7EEF4;
    }
  
    body.view-in-course .wrapper-footer {
      background-color: #E7EEF4;
    }
  
    .wrapper-footer .site-nav, .wrapper-footer footer#footer-openedx .colophon .nav-colophon {
      margin: 0 !important;
    }
  
    .wrapper-footer .site-nav .nav-link, .wrapper-footer footer#footer-openedx .colophon .nav-colophon li a {
      color: white !important;
    }
  
    #footer-openedx{
      display: flex;
  justify-content: space-between;
  
    }
    .footer--element{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 33%;
  }
  .footer-middle{
    justify-content: space-evenly;
  }
  .img-plus{
    margin-right: 15px;
  }
  .legal{
    text-transform: uppercase;
    color: rgb(0,91,144);
    font-weight: bold;
  }
  
  .facebook{
    width: 25px;
  }

  .footer--element--img_left{
width: 45%;
}

.footer--element--img_right{
width: 30%;
}

.header_admin-menu--container{
  display: flex;
  justify-content: space-between;
}

.header_admin-menu{
  display: flex;
  justify-content: center;
}

.admin-menu__list{
  list-style: none;
  display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
}
.admin-menu__list--element{
  margin-bottom: 1.2em;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  margin-left: 15px;
  margin-right: 15px;
margin-top: 5px;
}

.admin-menu__list--element_text{
  text-transform: uppercase;
  color: rgb(0,91,144);
  font-weight: bold;
  font-size: 1.4em;
  padding-bottom: 5px;
}

.admin-menu--img{
  width: 40px;
  margin-right: 10px;
}

.admin-menu__list--button_div{
  display: flex;
  align-items: center;
  color: #fff;
  width: 170px;
  padding: 10px;
  margin-bottom: 1.2em;
  margin-left: 15px;
}

.admin-menu__list--button_text{
  margin-bottom: 0;
  line-height: 16px;
}

.button_admin{
  background-color: rgb(0,91,144);
}

.button_user{
  background-color: rgb(52,128,195);
  cursor: pointer;
}

.admin-menu--img_user{
  width: 25px;
  margin-right: 10px;
}

.user_menu{
  border: 1px solid black;
  padding: 10px;
  margin-top: -15px;
  padding-right: 0;
  padding-top: 16px;
  margin-left: 15px;
  position: absolute;
  z-index: 10;
  background: white;
  line-height: 16px;
}
.add_a_response{
  display: flex;
  justify-content: flex-end;
}

.page-content-container {
    border: none !important
}

.page-header {
    border-bottom: none !important;
}

.new-comment{
  display: none;
}

.response-btn-count-wrapper{
  display: flex !important;
  justify-content: flex-end !important;
  margin-top: -60px !important;
}

.response-count{
  display: none;
}

.wmd-input{
  margin-top: 30px;
}

.forum-nav-browse-filter{
  display: none;
}

.forum-nav-browse-menu-item{
  background-color: #E7EEF4;
}

#all_discussions,
#topic_search_bar,
#add_new_message,
#posts_following {
  background-color: #fed016;
}

#all_discussions:first-child,
#add_new_message{
  text-align: center !important;
}

#all_discussions:first-child:hover{
  background-color: #fef1ba !important;
}



.thread-responses-wrapper, .post-extended-content {
    padding: 0;
}

.discussion-post .post-header-content .post-title {
    font-size: 30px;
}

.discussion-post {
    padding: 0 10px 0 60px !important;
}

.thread-main-wrapper {
    padding: 1em;
}

.post-title,
.post-body,
.response-body {
  color: rgb(0,91,144);
}

.forum-nav-browse-title {
    border-bottom: none !important;

}


.search-button{
  width: 10px;
  position: relative;
  left: -30px;
  color: transparent;
  border: none;
  background-image: url("/static/bim/images/loupe.svg");
  background-repeat: no-repeat;
  background-size: contain;
  background-position: center;
}

.btn-outline-primary:hover {
    background-color: inherit !important;
    border-color: inherit !important;
    border:none
}

.form-control {
    border: 2px solid rgb(0,91,144);
}

.toggle_text {
    margin-top: 15px;
    margin-left: 10px;
    text-transform: uppercase;
    color: rgb(0,91,144);
}

.toggle_image {
    width: 30px;
    height: auto;
}

.toggle_button{
    display: flex;
    align-items: center;
    cursor: pointer;
}

.add-response-btn{
  border: none;
  display: flex !important;
}

.yellow_bullet{
  position: absolute;
left: 13px;
width: 35px;
top: 15px;
}

#blue_bullet {
    position: absolute;
    width: 35px;
    top: 21px;
}

.forum-nav-thread .forum-nav-thread-link.is-active {
    background-color: #e7eef4
}

.forum-nav-thread .forum-nav-thread-link:hover {
  background-color: #e7eef4
}
.forum-nav-refine-bar {
    background-color: #3280c2;

}
</style>


<header class="header_admin-menu--container">
  <div class="header_admin-menu" style="width: 18%;">
  </div>
  <div class="header_admin-menu">
    <a href="/courses/course-v1:bim+FR+2021/b21982c4a63e4667905f15529c7375c6/">
      <div class="admin-menu__list--element">
        <img class="admin-menu--img" src="${static.url('bim/images/picto-boite-a-outils.svg')}" alt="logo boite à outils" id="toolbox-logo"/>
        <p class="admin-menu__list--element_text">Boite à outils</p>
      </div>
    </a>
    <a href="#">
      <div class="admin-menu__list--element">
        <img class="admin-menu--img" src="${static.url('bim/images/picto-forum.svg')}" alt="logo boite à outils" id="toolbox-logo"/>
        <p class="admin-menu__list--element_text">Forum</p>
      </div>
    </a>
  </div>
  <div class="header_admin-menu">
  %if staff_access:
    <a href="/wul_apps/dashboard/home">
      <div>
        <div class="admin-menu__list--button_div button_admin " >
          <img class="admin-menu--img_user" src="${static.url('bim/images/head.png')}" alt="logo boite à outils" id="toolbox-logo"/>
          <p class="admin-menu__list--button_text">Espace administrateur</p>
        </div>
      </div>
    </a>
  %endif
  <div>
      <div id="user_menu_button" class="admin-menu__list--button_div button_user" >
        <img class="admin-menu--img_user" src="${static.url('bim/images/head.png')}" alt="logo boite à outils" id="toolbox-logo"/>
        <p class="admin-menu__list--button_text">Espace utilisateur</p>
      </div>
      <div id="user_menu_items" class="user_menu" style="display: none;" >
        <div class="mobile-nav-item dropdown-item dropdown-nav-item"><a href="${reverse('dashboard')}" role="menuitem">${_("Dashboard")}</a></div> <hr>
        <div class="mobile-nav-item dropdown-item dropdown-nav-item"><a href="${reverse('account_settings')}" role="menuitem">${_("Account")}</a></div> <hr>
        <div class="mobile-nav-item dropdown-item dropdown-nav-item"><a href="${reverse('logout')}" role="menuitem">${_("Sign Out")}</a></div>
      </div>
    </div>
  </div>
</header>

<section class="discussion discussion-board page-content-container" id="discussion-container"
         data-course-id="${course.id}"
         data-user-create-comment="${json.dumps(can_create_comment)}"
         data-user-create-subcomment="${json.dumps(can_create_subcomment)}"
         data-read-only="false"
         data-sort-preference="${sort_preference}"
         data-flag-moderator="${json.dumps(flag_moderator)}"
         data-user-group-id="${user_group_id}">
    <header class="page-header has-secondary">
        ## Breadcrumb navigation
        <div class="page-header-main">
            <nav aria-label="${_('Discussions')}" class="sr-is-focusable" tabindex="-1">
                <div class="has-breadcrumbs"></div>
            </nav>
        </div>
        <div class="page-header-secondary">
            ## Add Post button
            % if has_permission(user, 'create_thread', course.id):
            <div class="forum-actions">
                <button class="btn btn-outline-primary btn-small new-post-btn">${_("Add a Post")}</button>
            </div>
            % endif
            ## Search box
            <div class="forum-search"></div>
        </div>
    </header>
    % if course_expiration_fragment:
        ${HTML(course_expiration_fragment.content)}
    % endif
    <div class="page-content"
      % if getattr(course, 'language'):
        lang="${course.language}"
      % endif
    >
        <div class="discussion-body">
            <main id="main" class="discussion-column" aria-label="Content" tabindex="-1">
                <article class="new-post-article is-hidden" style="display: none" tabindex="-1" aria-label="${_("New topic form")}"></article>
                <div class="forum-content"></div>
            </main>
            <aside class="forum-nav" role="complementary" aria-label="${_("Discussion thread list")}">
                <%include file="_filter_dropdown.html" />
                <div class="discussion-thread-list-container"></div>
            </aside>
        </div>
    </div>
</section>

<%include file="_underscore_templates.html" />
<%include file="_thread_list_template.html" />

<%static:require_module_async module_name="js/commerce/track_ecommerce_events" class_name="TrackECommerceEvents">

  var fbeLink = $("#FBE_banner");

  TrackECommerceEvents.trackUpsellClick(fbeLink, 'discussion_audit_access_expires', {
      pageName: "discussion_tab",
      linkType: "link",
      linkCategory: "FBE_banner"
  });

</%static:require_module_async>

<div class="wrapper wrapper-footer">
    <footer id="footer-openedx" class="grid-container"
      ## When rendering the footer through the branding API,
      ## the direction may not be set on the parent element,
      ## so we set it here.
      % if bidi:
        dir=${bidi}
      % endif
    >
    <div class="footer--element footer-left">
      <img class="footer--element--img_left" src="${static.url('bim/images/logo_1_ADN.png')}" alt="logo ADN"/>
      <img class="footer--element--img_right" src="${static.url('bim/images/logo_2_ministere.svg')}" alt="logo_ministere"/>
    </div>

    <div class="footer--element footer-middle">
      <a href="#">
        <img class="admin-menu--img facebook" src="${static.url('bim/images/picto-facebook.svg')}" alt="logo facebook"/>
      </a>
      <a href="#">
        <img class="admin-menu--img" src="${static.url('bim/images/twiter-logo.svg')}" alt="logo twitter"/>
      </a>
      <a href="#">
        <img class="admin-menu--img" src="${static.url('bim/images/picto-instagram.svg')}" alt="logo linkedin"/>
      </a>
    </div>

    <a class="footer--element footer-right" href="#">
        <img class="admin-menu--img img-plus" src="${static.url('bim/images/picto-plus.svg')}" alt="picto plus"/>
        <p class="legal">Infos légales</p>
    </a>
    </footer>
  </div>


  <script>
    function toggleMenu () {
      let menu = document.getElementById("user_menu_items");
      if (menu.style.display === "none") {
        menu.style.display = "block";
      } else {
        menu.style.display = "none";
      }
    }
    document.getElementById("user_menu_button").addEventListener("click", toggleMenu)
  </script>
  
  <script>
    $('#amazonfreetextcomment').hide()
    $('.wrapper-course-material').hide()
  </script>




<script>
  let attributes = document.getElementsByClassName("comment-form")
  let responses = document.getElementsByClassName("discussion-response")
  toggleButton = document.createElement("div")
  toggleButton.innerHTML = "<div class='toggle_button'><img class='toggle_image' src =\"${static.url('bim/images/bouton-repondre.svg')}\" alt='picto valid'><p class='toggle_text'>Répondre</p></div>";
  let answerBlock = document.getElementsByClassName("thread-content-wrapper")

  function displayBullet() {
    let parentAnswer = document.getElementsByClassName("thread-main-wrapper")[0];
    let postFollowingAnswer = document.getElementsByClassName("thread-content-wrapper")[0];
    let blueBullet = document.createElement("div");
    blueBullet.id="blue_bullet"
    blueBullet.innerHTML = "<img src =\"${static.url('bim/images/picto-bulle-bleu.svg')}\" class='blue_bullet' alt='blue bullet'>"

    parentAnswer.insertBefore(blueBullet, postFollowingAnswer)

    // let parentAnswerArray = document.getElementsByClassName("forum-response")
    let responsesArray = document.getElementsByClassName("discussion-response")

    let yellowBullet = document.createElement("div");
    yellowBullet.id="yellow_bullet"
    yellowBullet.innerHTML = "<img src =\"${static.url('bim/images/picto-bulle-jaune.svg')}\" class='yellow_bullet' alt='yellow bullet'>"

    for (let i = 0; i < responsesArray.length; i++){
      responsesArray[i].appendChild(yellowBullet.cloneNode(true))
        };
  }

  function displayToggleButton () {
      if (document.getElementsByClassName("add_a_response").length === 0) {
     
        for (let i = 0; i < responses.length; i++){
          toggleButton.classList.add("add_a_response");
          responses[i].appendChild(toggleButton.cloneNode(true))
          responses[i].addEventListener("click", function(){
            attributes[i].parentNode.style.display = "inherit"
        });
      }
    }
  }

  function addLastAnswerButton(){
    let responsesLenght = responses.length
    let lastResponse = responses[responsesLenght - 1]

    let attributesLenght = attributes.length
    let lastAttribute = attributes[attributesLenght - 1]

    toggleButton.classList.add("add_a_response");
    lastResponse.appendChild(toggleButton)
    lastResponse.addEventListener("click", function(){
            lastAttribute.parentNode.style.display = "inherit"
        });
  }


  function walkText(node) {
  if (node.nodeType == 3) {
    node.data = node.data.replace(/000r/g, "");
  }
  if (node.nodeType == 1 && node.nodeName != "SCRIPT") {
    for (var i = 0; i < node.childNodes.length; i++) {
      walkText(node.childNodes[i]);
    }
  }
}

  function checkifButtonisDisplayed() {
    if (document.getElementsByClassName("add_a_response").length === 0) {
      displayToggleButton();
    }
    if (document.getElementsByClassName("new-main-button").length === 0) {
      displayMainButton();
    }
    if (document.getElementsByClassName("discussion-response").length !== document.getElementsByClassName("add_a_response").length) {
      addLastAnswerButton();
    }
    if (!document.getElementById("topic_search_bar")) {
      displayElements();
    }
    if (!document.getElementById("blue_bullet")) {
      displayBullet();
    }
    walkText(document.body);
  }



  function displayElements(){
    document.getElementsByClassName("search-button")[0].textContent =""
    let parentUl = document.getElementById("discussion_topics_listbox")

    let searchBarLi = document.createElement("li")
    searchBarLi.id = "topic_search_bar"
    let searchBar = document.getElementsByClassName("forum-search")[0]
    searchBarLi.appendChild(searchBar)


    let allDiscussions = document.getElementById("all_discussions")
    let postsFollowing = document.getElementById("posts_following")

    parentUl.insertBefore(searchBarLi, postsFollowing)
  }

  function displayMainButton () {
    let mainResponse = document.getElementsByClassName("response-btn-count-wrapper")[0]
    mainResponse.innerHTML = "<div class='new-main-button add-response btn btn-outline-primary btn-small add-response-btn'><img class='toggle_image' src =\"${static.url('bim/images/bouton-repondre.svg')}\" alt='picto valid'><p class='toggle_text'>Répondre</p></div>"
  }

  window.addEventListener("load", displayToggleButton)
  window.addEventListener("load", displayElements)
  window.addEventListener("load", walkText(document.body))

  
setInterval(function(){ checkifButtonisDisplayed(); }, 1500);


</script>


