<%page expression_filter="h"/>
<%inherit file="/main.html" />
<%namespace name='static' file='/static_content.html'/>
<%def name="online_help_token()"><% return "courseware" %></%def>
<%!
import six
import waffle

from django.conf import settings
from django.urls import reverse
from django.utils.translation import ugettext as _

from lms.djangoapps.edxnotes.helpers import is_feature_enabled as is_edxnotes_enabled
from openedx.core.djangolib.js_utils import js_escaped_string
from openedx.core.djangolib.markup import HTML
from openedx.features.course_experience import course_home_page_title, DISABLE_COURSE_OUTLINE_PAGE_FLAG
import json
import time
%>
<%
  include_special_exams = (
  request.user.is_authenticated and
  settings.FEATURES.get('ENABLE_SPECIAL_EXAMS', False) and
  (course.enable_proctored_exams or course.enable_timed_exams)
  )
%>
<% user_name = str(user_metadata['username']) %>

<!-- Cyril - Limit test time to 1hr15min -->
<%
custom_fields = {}
custom_fields = json.loads(user.profile.custom_field)
timestamp = int(round(time.time() * 1000))

if (str(course.id) in custom_fields.keys()) and (custom_fields[str(course.id)] == 'quizz_completed'):
  closing_time = 'quizz_completed'

elif (str(course.id) in custom_fields.keys()) and (custom_fields[str(course.id)] != 'NaN'):
  closing_time = int(custom_fields[str(course.id)]) + 1000*60*60*1.25

else :
  custom_fields[str(course.id)] = timestamp
  user.profile.custom_field = json.dumps(custom_fields)
  user.profile.save()
  closing_time = int(custom_fields[str(course.id)]) + 1000*60*60*1.25
%>

<script type="text/javascript">
  var $$course_id = "${course.id | n, js_escaped_string}";
  var courseId = "${course.id}";
</script>


<style>
  .window-wrap {
    background: url("${static.url('bvt/images/bg_img.png')}");
    background-size: contain;
  }
  .content-wrapper {
    background : white;
  }
  #timer_bvt {
    position: -webkit-sticky;
    position: sticky;
    top: 5px;
    width: 250px;
    margin: auto;
    border: black solid 2px;
    border-radius: 15px;
    background-color: white;
    z-index: 99;
    font-family: 'Roboto';
    font-size: 1.5rem;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .bookmark-button {
    display: none;
  }
  #logout-button-end:hover {
    background-color: #065683;
    cursor: pointer;
  }
  #logout-button-end {
    padding: 20px;
    width: 344px;
    text-align: center;
    margin: 30px auto;
    background-color: #31AA47 ;
    border-radius: 7px;
  }
  #logout-button-end > a {
    margin-bottom: 0;
    text-align: center;
    text-decoration: none;
    color: white;
  }

</style>

% if display_reset_dates_banner:
    <script type="text/javascript">
        $('.reset-deadlines-banner').css('display', 'flex');
    </script>
% endif
<%def name="course_name()">
 <% return _("{course_number} Courseware").format(course_number=course.display_number_with_default) %>
</%def>

<%block name="bodyclass">view-in-course view-courseware courseware ${course.css_class or ''}</%block>

<%block name="title">
<title data-base-title="${static.get_page_title_breadcrumbs(section_title, course_name())}">
  ${static.get_page_title_breadcrumbs(sequence_title, section_title, course_name())}
</title>
</%block>

<%block name="header_extras">

% for template_name in ["image-modal"]:
<script type="text/template" id="${template_name}-tpl">
    <%static:include path="common/templates/${template_name}.underscore" />
</script>
% endfor

% if include_special_exams is not UNDEFINED and include_special_exams:
  % for template_name in ["proctored-exam-status"]:
    <script type="text/template" id="${template_name}-tpl">
        <%static:include path="courseware/${template_name}.underscore" />
    </script>
  % endfor
% endif

</%block>

<%block name="headextra">
<%static:css group='style-course-vendor'/>
<%static:css group='style-course'/>
## Utility: Notes
% if is_edxnotes_enabled(course, request.user):
<%static:css group='style-student-notes'/>
% endif

<script type="text/javascript" src="${static.url('js/jquery.autocomplete.js')}"></script>
<script type="text/javascript" src="${static.url('js/src/tooltip_manager.js')}"></script>

<link href="${static.url('css/vendor/jquery.autocomplete.css')}" rel="stylesheet" type="text/css">
  ${HTML(fragment.head_html())}
</%block>

<%block name="js_extra">
  <script type="text/javascript" src="${static.url('common/js/vendor/jquery.scrollTo.js')}"></script>
  <script type="text/javascript" src="${static.url('js/vendor/flot/jquery.flot.js')}"></script>

  <%static:js group='courseware'/>
  <%include file="/mathjax_include.html" args="disable_fast_preview=True"/>

  % if show_search:
    <%static:require_module module_name="course_search/js/course_search_factory" class_name="CourseSearchFactory">
        var courseId = $('.courseware-results').data('courseId');
        CourseSearchFactory({
            courseId: courseId,
            searchHeader: $('.search-bar')
        });
    </%static:require_module>
  % endif

  <%static:require_module module_name="js/courseware/courseware_factory" class_name="CoursewareFactory">
    CoursewareFactory();
  </%static:require_module>

  % if staff_access:
  	<%include file="xqa_interface.html"/>
  % endif

  % if not request.user.is_authenticated:
      <script type="text/javascript">
        // Disable discussions
        $('.xblock-student_view-discussion button.discussion-show').attr('disabled', true);

        // Insert message informing user discussions are only available to logged in users.
        $('.discussion-module')
      </script>
  % endif

${HTML(fragment.foot_html())}

</%block>

<div class="message-banner" aria-live="polite"></div>

% if default_tab:
  <%include file="/courseware/course_navigation.html" />
% else:
  <%include file="/courseware/course_navigation.html" args="active_page='courseware'" />
% endif

<div class="container"
  % if getattr(course, 'language'):
    lang="${course.language}"
  % endif
  >
  <div class="course-wrapper" role="presentation">

% if disable_accordion is UNDEFINED or not disable_accordion:
    <div class="course-index">

      <div class="wrapper-course-modes">

          <div class="courseware-bookmarks-button">
              <a class="bookmarks-list-button" href="${reverse('openedx.course_bookmarks.home', args=[course.id])}">
                  ${_('Bookmarks')}
              </a>
          </div>

          % if show_search:
            <div id="courseware-search-bar" class="search-bar courseware-search-bar" role="search" aria-label="Course">
              <form class="search-form">
                <label for="course-search-input" class="sr">${_('Course Search')}</label>
                <div class="search-field-wrapper">
                  <input id="course-search-input" type="text" class="search-field"/>
                  <button type="submit" class="search-button">${_('Search')}</button>
                  <button type="button" class="cancel-button" title="${_('Clear search')}">
                    <span class="icon fa fa-remove" aria-hidden="true"></span>
                  </button>
                </div>
              </form>
            </div>
          % endif

      </div>

      <div class="accordion">
        <nav class="course-navigation" aria-label="${_('Course')}">
          % if accordion.strip():
            ${HTML(accordion)}
          % else:
            <div class="chapter">${_("No content has been added to this course")}</div>
          % endif
        </nav>
      </div>

    </div>
% endif
    <section class="course-content" id="course-content">
        <header class="page-header has-secondary">
            <div class="page-header-main">
                <nav aria-label="${_('Course')}" class="sr-is-focusable" tabindex="-1">
                    <div class="has-breadcrumbs">
                        <div class="breadcrumbs" style="display: none;">
                            % if not DISABLE_COURSE_OUTLINE_PAGE_FLAG.is_enabled(course.id):
                                <span class="nav-item nav-item-course">
                                    <a href="${course_url}">${course_home_page_title(course)}</a>
                                </span>
                                <span class="icon fa fa-angle-right" aria-hidden="true"></span>
                            % endif
                            % if chapter:
                                <span class="nav-item nav-item-chapter" data-course-position="${course.position}" data-chapter-position="${chapter.position}">
                                    <a href="${course_url}#${six.text_type(chapter.location)}">${chapter.display_name_with_default}</a>
                                </span>
                                <span class="icon fa fa-angle-right" aria-hidden="true"></span>
                            % endif
                            % if section:
                                <span class="nav-item nav-item-section">
                                    <a href="${course_url}#${six.text_type(section.location)}">${section.display_name_with_default}</a>
                                </span>
                                <span class="icon fa fa-angle-right" aria-hidden="true"></span>
                            % endif
                            <span class="nav-item nav-item-sequence">${sequence_title}</span>
                        </div>
                    </div>
                </nav>
            </div>
        </header>
        <div id="timer_bvt" >Temps restant : <span id='timer_digits'>XX:XX</span>
          <div>
            <a id="link_progression" href="">
              Ma Progression
            </a>
          </div>
        </div>

        <main id="main" tabindex="-1" aria-label="Content">
            % if getattr(course, 'entrance_exam_enabled') and \
               getattr(course, 'entrance_exam_minimum_score_pct') and \
               entrance_exam_current_score is not UNDEFINED:
                % if not entrance_exam_passed:
                <p class="sequential-status-message">
                    ${_('To access course materials, you must score {required_score}% or higher on this \
                    exam. Your current score is {current_score}%.').format(
                        required_score=int(round(course.entrance_exam_minimum_score_pct * 100)),
                        current_score=int(round(entrance_exam_current_score * 100))
                    )}
                </p>
                <script type="text/javascript">
                $(document).ajaxSuccess(function(event, xhr, settings) {
                    if (settings.url.indexOf("xmodule_handler/problem_check") > -1) {
                        var data = JSON.parse(xhr.responseText);
                        if (data.entrance_exam_passed){
                            location.reload();
                        }
                    }
                });
                </script>
                % else:
                  <p class="sequential-status-message">
                    ${_('Your score is {current_score}%. You have passed the entrance exam.').format(
                        current_score=int(round(entrance_exam_current_score * 100))
                    )}
                </p>
                % endif
            % endif

              ${HTML(fragment.body_html())}
        </main>
    </section>

    <section class="courseware-results-wrapper">
      <div id="loading-message" aria-live="polite" aria-relevant="all"></div>
      <div id="error-message" aria-live="polite"></div>
      <div class="courseware-results search-results" data-course-id="${course.id}" data-lang-code="${language_preference}"></div>
    </section>

  </div>
  ${HTML(course_sock_fragment.body_html())}
</div>
<div class="container-footer">
  % if settings.FEATURES.get("LICENSING", False):
    <div class="course-license">
    % if getattr(course, "license", None):
      <%include file="../license.html" args="license=course.license" />
    % else:
      ## Default course license: All Rights Reserved, if none is explicitly set.
      <%include file="../license.html" args="license='all-rights-reserved'" />
    % endif
    </div>
  % endif
</div>
% if course.show_calculator or is_edxnotes_enabled(course, request.user):
    <nav class="nav-utilities ${"has-utility-calculator" if course.show_calculator else ""}" aria-label="${_('Course Utilities')}">
      ## Utility: Notes
      % if is_edxnotes_enabled(course, request.user):
        <%include file="/edxnotes/toggle_notes.html" args="course=course"/>
      % endif

      ## Utility: Calc
      % if course.show_calculator:
        <%include file="/calculator/toggle_calculator.html" />
      % endif
    </nav>
% endif

<%static:require_module_async module_name="js/commerce/track_ecommerce_events" class_name="TrackECommerceEvents">

  var fbeLink = $("#FBE_banner");
  var welcomeLink = $("#welcome");
  var accessDeniedUpsellLink = $("#accessDeniedUpsell");
  var sockLink = $("#sock");

  TrackECommerceEvents.trackUpsellClick(fbeLink, 'in_course_audit_access_expires', {
      pageName: "in_course",
      linkType: "link",
      linkCategory: "FBE_banner"
  });

  TrackECommerceEvents.trackUpsellClick(welcomeLink, 'in_course_welcome', {
      pageName: "in_course",
      linkType: "link",
      linkCategory: "welcome"
  });

  TrackECommerceEvents.trackUpsellClick(accessDeniedUpsellLink, 'in_course_upgrade', {
    pageName: "in_course",
    linkType: "link",
    linkCategory: "(none)"
  });

  TrackECommerceEvents.trackUpsellClick(sockLink, 'in_course_sock', {
      pageName: "in_course",
      linkType: "button",
      linkCategory: "green_upgrade"
  });

</%static:require_module_async>


<!-- Cyril - Limit test time to 75 min -->
<script>
  let link_progression = '/courses/'+$$course_id+"/courseware/d4a9392d58cb49fba5afe41b33aa8f9e/310e3b2e46784b028a88a55034f35ce7/?child=first"
  document.getElementById('link_progression').setAttribute('href', link_progression)

  const userName = "${user_name}"
  const closingTime = "${closing_time}"
  let currentTime 
  var checkTime = setInterval(() => {

    currentTime = Date.now();
    if (closingTime === "quizz_completed") {
      clearInterval(checkTime)
      alert("\nVotre session d'examen est terminée.\n\nToutes vos réponses ont bien été enregistrées.\nNous reviendront prochainement vers vous pour vous communiquer vos résultats.\n\nCordialement, \nl'Équipe BVT\n\n")
      window.location.replace("/courses/"+$$course_id+"/course/");
    } 
    else if (closingTime < currentTime) {
      clearInterval(checkTime)
      alert("\nVotre session d'examen est expirée. Vous avez dépassé la limite de temps allouée.\n\nToutes vos réponses ont cependant bien été enregistrées.\nNous reviendront prochainement vers vous pour vous communiquer vos résultats.\n\nCordialement, \nl'Équipe BVT\n\n")
      window.location.replace("/courses/"+$$course_id+"/course/");
    }

    // Add timer here
    let timer_delta = closingTime - currentTime
    let timer = new Date(timer_delta);
    let hour = timer.getHours();
    let minutes = timer.getMinutes();
    minutes = ("0"+minutes).slice(-2);
    let seconds = timer.getSeconds();
    seconds = ("0"+seconds).slice(-2);

    if (hour == 2) {
      document.getElementById('timer_digits').textContent = String(Number(minutes)+60) + ':'+ seconds
    } else {
      document.getElementById('timer_digits').textContent = minutes + ':'+ seconds
    }
    // Add timer here

  }, 500);
</script>


<!-- Cyril - Display disconnect button at the end-->
<script>
let finished_exam = setInterval(() => {
  let div_completion = document.getElementById('quiz_passed')

  if (div_completion.style.display == "block") {

    var logout_button = document.createElement("div");
    // logout_button.innerHTML = "<div id='logout-button-end' ><a href='/logout'>Valider et terminer l'examen</a></div>"
    logout_button.innerHTML = "<div id='logout-button-end' >Valider et terminer l'examen</div>"

    div_completion.appendChild(logout_button);

    logout_button.addEventListener("click", function(){

      function decodeHtml(html) {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
      }

      function convertToJsObject(escapedJson) {
        // Decode HTML entities
        const decodedString = decodeHtml(escapedJson);
        
        // Replace single quotes with double quotes for JSON
        const jsonString1 = decodedString.replace(/'/g, '"');
        const jsonString2 = jsonString1.replace(/True/g, 'true');
        const jsonString3 = jsonString2.replace(/False/g, 'false');
        const jsonString = jsonString3.replace(/None/g, 'null');
        
        // Parse JSON to get a JavaScript object
        return JSON.parse(jsonString);
      }

      
      const customFieldsStr = "${custom_fields}";
      const customFieldsObj = convertToJsObject(customFieldsStr);

      const courseID = "${course.id}"
      const today = new Date();
      const timestamp = today.getTime();

      customFieldsObj[courseID] = "quizz_completed"
      customFieldsObj["authorized"] = true
      customFieldsObj['session_date'] = timestamp


      const url = '/wul_apps/custom_field_editor/';
      const data = JSON.stringify(customFieldsObj);
      const settings = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": $.cookie('csrftoken'),
        },
        body: data
      };

      fetch(url, settings)
      .then(() => window.location.reload())
      .catch((error) => console.error('Error:', error));

    });

    clearInterval(finished_exam)
  }
}, 500);

</script>

