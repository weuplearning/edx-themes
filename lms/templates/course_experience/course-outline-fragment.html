## mako

<%page expression_filter="h"/>

<%namespace name='static' file='../static_content.html'/>

<%!
import json
import pytz
from datetime import date, datetime, timedelta

from django.utils import timezone
from django.utils.translation import gettext as _
from django.utils.translation import ngettext

from lms.djangoapps.courseware.access import has_access
from openedx.core.djangolib.markup import HTML, Text
from openedx.features.course_experience import RELATIVE_DATES_FLAG
from openedx.core.djangoapps.site_configuration import helpers as configuration_helpers
%>

<%
course_sections = blocks.get('children')
self_paced = context.get('self_paced', False)
relative_dates_flag_is_enabled = RELATIVE_DATES_FLAG.is_enabled(str(course_key))
is_course_staff = bool(user and course and has_access(user, 'staff', course, course.id))
dates_banner_displayed = False
%>

<%
file_path = '/edx/var/edxapp/media/microsites/umn/fichiers_json/course_overview.json'
with open(file_path, 'r') as file:
  data = json.load(file)

for key, value in data.items() :
  if key == str(course.id) :
    json_img_link = value["img_link"]
%>

<main role="main" class="course-outline" id="main" tabindex="-1">
    <%include file="/dates_banner.html" />
    % if course_sections is not None:
        <button class="btn btn-primary" id="expand-collapse-outline-all-button" aria-expanded="false" aria-controls="course-outline-block-tree" >
          <span class="expand-collapse-outline-all-extra-padding" id="expand-collapse-outline-all-span">${_("Expand All")}</span>
        </button>
        <ol class="block-tree accordion vertical-align" id="course-outline-block-tree" aria-labelledby="expand-collapse-outline-all-button">

        % for primary_index, section in enumerate(course_sections):
            <%
            section_is_auto_opened = section.get('resume_block') is True
            scored = 'scored' if section.get('scored', False) else ''
            %>
            <li class="outline-item section ${scored}">
                <img class="vignette-section-img" src="${static.url(json_img_link[primary_index])}" alt="section-image">
                <div class="right-panel">
                    <button class="section-name accordion-trigger outline-button" aria-expanded="${ 'true' if section_is_auto_opened else 'false' }" aria-controls="${ section['id'] }_contents" id="${ section['id'] }">
                        <h3 class="section-title">${ section['display_name'] }</h3>
                        <span class="fa fa-chevron-right ${ 'fa-rotate-90' if section_is_auto_opened else '' }" aria-hidden="true"></span>

                        <!-- InsÃ©rer les jauges ici -->
                        %if configuration_helpers.get_value('COMPLETION_BASED_DASHBOARD_MONO', False):

                            <%
                            total_blocks = 1
                            completed_blocks = 0

                            if not section.get('complete'):
                                total_blocks = 0
                                completed_blocks = 0
                                for subsection in section.get('children', []):
                                    for unitchild in subsection.get('children', []):
                                        for blockchild in unitchild.get('children', []):
                                            total_blocks += 1
                                            if blockchild.get('complete'):
                                                completed_blocks += 1
                            if total_blocks == 0:
                                completion_ratio = 0
                            else:
                                completion_ratio = completed_blocks / total_blocks
                            %>

                            <div class="progress_bar_and_score">
                                <div class="progress-bar-full animate">
                                    <span style="width:${(completion_ratio * 100)}%;" class="progress-bar-grade progress_bar_index_${primary_index}"><span></span></span>
                                </div>
                                <h2 class="completed_percent"> ${int(completion_ratio * 100)} %</h2>
                            </div>

                        %else:

                            %for index, chapter in enumerate(user_grade.chapter_grades.keys()):
                                %if section['display_name'] == user_grade.chapter_grades[chapter]['display_name']:

                                    %if user_grade.chapter_percentage(chapter) != 1 :
                                    <div class="progress_bar_and_score">
                                        <div class="progress-bar-full animate">
                                            <span style="width:${int(user_grade.chapter_percentage(chapter) * 100)}%;" class="progress-bar-grade progress_bar_index_${primary_index}"><span></span> </span>
                                        </div>
                                        <h2 class="completed_percent"> ${int(user_grade.chapter_percentage(chapter) * 100)} %</h2>  
                                        <span id="checkmark-ongoing" ></span>
                                    </div>
                                    %else :
                                    <div class="progress_bar_and_score finish">
                                        <div class="progress-bar-full animate">
                                            <span style="width:${int(user_grade.chapter_percentage(chapter) * 100)}%;" class="progress-bar-grade progress_bar_index_${primary_index}"><span></span></span>
                                        </div>
                                        <h2 class="completed_percent"> ${int(user_grade.chapter_percentage(chapter) * 100)} %</h2>
                                        <span id="checkmark-finish" ></span>
                                    </div>
                                    %endif 

                                %endif
                            %endfor

                        %endif
                    </button>

                    <ol class="outline-item accordion-panel ${ '' if section_is_auto_opened else 'is-hidden' }"
                        id="${ section['id'] }_contents"
                        aria-labelledby="${ section['id'] }">
                    % for subsection in section.get('children', []):
                        <%
                        gated_subsection = subsection['id'] in gated_content
                        needs_prereqs = not gated_content[subsection['id']]['completed_prereqs'] if gated_subsection else False
                        scored = 'scored' if subsection.get('scored', False) else ''
                        graded = 'graded' if subsection.get('graded') else ''
                        num_graded_problems = subsection.get('num_graded_problems', 0)

                        %>
                        <li class="subsection accordion ${ 'current' if subsection.get('resume_block') else '' } ${graded} ${scored}" style="position: relative;">
                            <a href="${ subsection['lms_web_url'] }" class="subsection-text outline-button horizontal-align" id="${ subsection['id'] }" >
                                <h4 class="subsection-title">${ subsection['display_name'] }</h4>
                                %if subsection['complete'] :
                                <span id="checkmark-finish-sub" ></span>
                                %endif
                            </a>
                        </li>
                    % endfor
                    </ol>
                </div>
            </li>
        % endfor
        </ol>
    % endif
</main>

<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform('.localized-datetime');
</%static:require_module_async>

<%static:webpack entry="CourseOutline">
    new CourseOutline();
</%static:webpack>
