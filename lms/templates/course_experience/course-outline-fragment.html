## mako

<%page expression_filter="h"/>

<%namespace name='static' file='../static_content.html'/>

<%!
import json
import pytz
from datetime import date, datetime, timedelta

from django.utils import timezone
from django.utils.translation import gettext as _
from django.utils.translation import ngettext

from lms.djangoapps.courseware.access import has_access
from openedx.core.djangolib.markup import HTML, Text
from openedx.features.course_experience import RELATIVE_DATES_FLAG
%>

<%
course_sections = blocks.get('children')
self_paced = context.get('self_paced', False)
relative_dates_flag_is_enabled = RELATIVE_DATES_FLAG.is_enabled(str(course_key))
is_course_staff = bool(user and course and has_access(user, 'staff', course, course.id))
dates_banner_displayed = False

custom_fields_dict = json.loads(custom_fields)
user_firstname = custom_fields_dict.get('first_name', '')
user_lastname = custom_fields_dict.get('last_name', '')
user_structure = custom_fields_dict.get('structure', '')
user_preparedDiploma = custom_fields_dict.get('preparedDiploma', '')
user_regions = custom_fields_dict.get('regions', '')
user_agreeCgu = custom_fields_dict.get('agreeCgu', '')
user_status = custom_fields_dict.get('status', '')

display_form = False
if not all([user_firstname, user_lastname, user_structure, user_preparedDiploma, user_regions, user_agreeCgu, user_status]):
    display_form = True
%>


<style>
.content-wrapper {
    min-height: calc(100vh - 284px);
}
#customFieldsForm {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

#customFieldsForm label {
    margin-bottom: 10px;
    font-weight: bold;
}

#customFieldsForm input[type="text"] {
    padding: 5px;
    margin-bottom: 20px;
    border-radius: 3px;
    border: 1px solid #ccc;
    width: 100%;
    max-width: 400px;
}

#customFieldsForm select {
    padding: 5px;
    margin-bottom: 20px;
    border-radius: 3px;
    border: 1px solid #ccc;
    width: 100%;
    max-width: 400px;
}

#customFieldsForm button[type="submit"] {
    background-color: #007bff;
    color: #fff;
    padding: 10px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

#customFieldsForm button[type="submit"]:hover {
    background-color: #0056b3;
}

.disabled-link {
  pointer-events: none;
}
.required_field {
    color: red;
}
</style>

% if display_form:

<script>
    let startButton = document.getElementsByClassName('action-resume-course')
    startButton[0].classList.add("disabled-link")
</script>
<form id="customFieldsForm">
    <label for="lastName">Nom : <span class="required_field">*</span></label>
    <input type="text" id="lastName" name="lastName" onkeydown="if(event.keyCode==32) return false;" required><br>
  
    <label for="firstName">Prénom : <span class="required_field">*</span></label>
    <input type="text" id="firstName" name="firstName" onkeydown="if(event.keyCode==32) return false;" required><br>
  
    <label for="structure">Organisme (Lycée, université, entreprise..) : <span class="required_field">*</span></label>
    <input type="text" id="structure" name="structure" onkeydown="if(event.keyCode==32) return false;" required><br>

    <label for="preparedDiploma">Diplôme préparé : <span class="required_field">*</span></label>
    <input type="text" id="preparedDiploma" name="preparedDiploma" onkeydown="if(event.keyCode==32) return false;" required><br>

    <label for="status">Statut : <span class="required_field">*</span></label>
    <select id="status" name="status">
        <option value="learner">Apprenant</option>
        <option value="instructor">Formateur</option>
        <option value="convert">Demandeur d'emploi ou salarié en reconversion</option>
        <option value="other">Autre</option>
    </select>
    <br>

    <label for="regions">Région : <span class="required_field">*</span></label>
    <select id="regions" name="regions">
        <optgroup label="France métropolitaine">
          <option value="auvergne">Auvergne-Rhône-Alpes</option>
          <option value="bourgogne">Bourgogne-Franche-Comté</option>
          <option value="bretagne">Bretagne</option>
          <option value="centre">Centre-Val de Loire</option>
          <option value="corse">Corse</option>
          <option value="grandest">Grand Est</option>
          <option value="hautsdefrance">Hauts-de-France</option>
          <option value="iledefrance">Île-de-France</option>
          <option value="normandie">Normandie</option>
          <option value="nouvelleacquitaine">Nouvelle-Aquitaine</option>
          <option value="occitanie">Occitanie</option>
          <option value="paysdelaloire">Pays de la Loire</option>
          <option value="provence">Provence-Alpes-Côte d'Azur</option>
        </optgroup>
        <optgroup label="Outre-mer">
          <option value="guadeloupe">Guadeloupe</option>
          <option value="martinique">Martinique</option>
          <option value="guyane">Guyane</option>
          <option value="reunion">La Réunion</option>
          <option value="mayotte">Mayotte</option>
        </optgroup>
    </select>
    <br>

    <label for="agreeCgu">J'accepte d'être contacté(e) par l'UMN par e-mail : <span class="required_field">*</span></label>
    <select id="agreeCgu" name="agreeCgu">
        <option value="oui">Oui</option>
        <option value="non">Non</option>
    </select>
  
    <p><span class="required_field">*</span> champs obligatoires</p>
    <button type="submit">Envoyer</button>
</form>

%else :


    <!-- Scorm did not receive completion status so we have to check for grade details -->

    % if str(request.get_full_path).index('+test+test') != -1 :
<script>
    async function getData(ajaxurl) {
        return $.ajax({
            url: ajaxurl,
            type: 'GET',
            dataType: 'json',
        });
    };

    (async () => {
        const url = "/api/grades/v1/courses/course-v1:umn+test+test/?username=${user.username}";
        const result = await getData(url);

        let module_list = result[0]['summay']['section_breakdown']
        let section = document.getElementsByClassName("subsection")

        for (let i = 0; i < section.length; i++) {
            const element = section[i];
            let subsection_title = element.children[0].children[0].innerText

            for (let j = 0; j < module_list.length; j++) {
                const module = module_list[j];

                if (module.detail.indexOf(subsection_title) != -1) {
                    if (module.percent == 1) {
                        element.children[0].children[1].style.display = 'block'
                    }
                }
            }
        }
    })();
</script>

    % elif str(request.get_full_path).index('umn+pn+02') != -1 :
<!-- <script>
    async function getData(ajaxurl) {
        return $.ajax({
            url: ajaxurl,
            type: 'GET',
            dataType: 'json',
        });
    };

    (async () => {
        const url = "/api/grades/v1/courses/course-v1:umn+pn+02/?username=${user.username}";
        const result = await getData(url);

        let module_list = result[0]['summay']['section_breakdown']
        let section = document.getElementsByClassName("subsection")

        for (let i = 0; i < section.length; i++) {
            const element = section[i];
            let subsection_title = element.children[0].children[0].innerText

            for (let j = 0; j < module_list.length; j++) {
                const module = module_list[j];

                if (module.detail.indexOf(subsection_title) != -1) {
                    if (module.percent == 1) {
                        element.children[0].children[1].style.display = 'block'
                    }
                }
            }
        }
    })();
</script> -->

    % endif


<main role="main" class="course-outline" id="main" tabindex="-1">
    <%include file="/dates_banner.html" />
    % if course_sections is not None:
        <button class="btn btn-primary"
                id="expand-collapse-outline-all-button"
                aria-expanded="false"
                aria-controls="course-outline-block-tree"
                >
          <span class="expand-collapse-outline-all-extra-padding" id="expand-collapse-outline-all-span">${_("Expand All")}</span>
        </button>
        <ol class="block-tree accordion"
            id="course-outline-block-tree"
            aria-labelledby="expand-collapse-outline-all-button">
        % for section in course_sections:
            <%
            section_is_auto_opened = section.get('resume_block') is True
            scored = 'scored' if section.get('scored', False) else ''
            %>
                <li class="outline-item section ${scored}">

                % if str(request.get_full_path).index('+test+test') != -1 :
                    <button class="section-name outline-button"
                        aria-controls="${ section['id'] }_contents"
                        id="${ section['id'] }">
                % else :
                    <button class="section-name accordion-trigger outline-button"
                        aria-expanded="${ 'true' if section_is_auto_opened else 'false' }"
                        aria-controls="${ section['id'] }_contents"
                        id="${ section['id'] }">
                % endif

                        <span class="fa fa-chevron-right ${ 'fa-rotate-90' if section_is_auto_opened else '' }" aria-hidden="true"></span>
                        <h3 class="section-title">${ section['display_name'] }</h3>
                % if section.get('complete'):
                        <span class="complete-checkmark fa fa-check" aria-hidden="true"></span>
                        <span class="sr">${_("Completed")}</span>
                % endif
                    </button>
                    <ol class="outline-item accordion-panel ${ '' if section_is_auto_opened else 'is-hidden' }"
                        id="${ section['id'] }_contents"
                        aria-labelledby="${ section['id'] }">

                % for subsection in section.get('children', []):
                    <%
                    gated_subsection = subsection['id'] in gated_content
                    scored = 'scored' if subsection.get('scored', False) else ''
                    graded = 'graded' if subsection.get('graded') else ''
                    num_graded_problems = subsection.get('num_graded_problems', 0)
                    %>

                        <li class="subsection accordion ${ 'current' if subsection.get('resume_block') else '' } ${graded} ${scored}">
                            <a
                                href="${ subsection['lms_web_url'] }"
                                class="subsection-text outline-button"
                                id="${ subsection['id'] }"
                            >

                                <h4 class="subsection-title">${ subsection['display_name'] } </h4>

                            % if subsection.get('complete'):
                                <span class="complete-checkmark fa fa-check" aria-hidden="true"></span>
                            % else :
                                <span class="complete-checkmark fa fa-check" aria-hidden="true" style="display: none;"></span>
                            % endif

                            </a>
                        </li>
                % endfor
                    </ol>
                </li>
        % endfor
        </ol>
    % endif
</main>

% endif

<%static:require_module_async module_name="js/dateutil_factory" class_name="DateUtilFactory">
    DateUtilFactory.transform('.localized-datetime');
</%static:require_module_async>

<%static:webpack entry="CourseOutline">
    new CourseOutline();
</%static:webpack>


<script>
const form = document.getElementById("customFieldsForm");

form.addEventListener("submit", function(event) {
    event.preventDefault();

    const firstName = document.getElementById("firstName").value;
    const lastName = document.getElementById("lastName").value;
    const structure = document.getElementById("structure").value;
    const preparedDiploma = document.getElementById("preparedDiploma").value;
    const regions = document.getElementById("regions").value;
    const agreeCgu = document.getElementById("agreeCgu").value;
    const status = document.getElementById("status").value;

    const customFields = {
        first_name: firstName,
        last_name: lastName,
        structure: structure,
        preparedDiploma: preparedDiploma,
        regions: regions,
        agreeCgu: agreeCgu,
        agreeCguDate: '${datetime.now()}',
        status: status,
        authorized: true,
    };

    const url = '/wul_apps/custom_field_editor/';
    const data = JSON.stringify(customFields);
    const settings = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": $.cookie('csrftoken'),
        },
        body: data
    };

    fetch(url, settings)
        .then(() => window.location.reload())
        .catch((error) => console.error('Error:', error));

});
</script>